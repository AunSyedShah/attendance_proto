{% extends 'base.html' %}

{% block title %}Attendance - Face Recognition System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Mark Attendance</h3>
                    <small>Position your face in front of the camera</small>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <video id="video" width="640" height="480" autoplay style="border: 2px solid #ddd; border-radius: 8px;"></video>
                        <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <button id="startBtn" class="btn btn-success btn-lg me-2" onclick="startCamera()">
                            <i class="fas fa-camera"></i> Start Camera
                        </button>
                        <button id="stopBtn" class="btn btn-danger btn-lg" onclick="stopCamera()" disabled>
                            <i class="fas fa-stop"></i> Stop Camera
                        </button>
                    </div>
                    
                    <div id="status" class="mt-3 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Click "Start Camera" to begin attendance marking
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Session Info Card -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Current Session</h5>
                </div>
                <div class="card-body">
                    <div id="sessionInfo">
                        <p class="mb-0">Loading session information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let processingInterval;
let stream;

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'user'
            } 
        });
        video.srcObject = stream;
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        
        updateStatus('Camera started. Position your face in the frame.', 'info');
        
        // Start processing frames
        processingInterval = setInterval(processFrame, 1000); // Process every second
        
    } catch (err) {
        console.error('Error accessing camera:', err);
        updateStatus('Error accessing camera: ' + err.message, 'danger');
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    if (processingInterval) {
        clearInterval(processingInterval);
    }
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    
    updateStatus('Camera stopped.', 'secondary');
    
    // Notify server to stop camera processing
    fetch('/stop_camera', {
        method: 'POST'
    });
}

function processFrame() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, 640, 480);
        
        canvas.toBlob(blob => {
            if (blob) {
                const formData = new FormData();
                formData.append('frame', blob);
                
                fetch('/process_frame', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.person_name && data.person_name !== 'Unknown') {
                            // Use enhanced message if available, otherwise fallback to basic message
                            const message = data.message || ('Attendance marked for: ' + data.person_name);
                            
                            // Determine alert type based on daily attendance action
                            let alertType = 'success';
                            if (data.daily_attendance) {
                                const action = data.daily_attendance.action;
                                if (action === 'rejected') {
                                    alertType = 'warning';
                                } else if (action === 'completed') {
                                    alertType = 'info';
                                } else if (action === 'out') {
                                    alertType = 'info';
                                }
                            }
                            
                            updateStatus(message, alertType);
                            loadSessionInfo(); // Refresh session info
                        } else {
                            updateStatus('Face detected but not recognized. Please ensure proper lighting.', 'warning');
                        }
                    } else {
                        updateStatus(data.message || 'Processing frame...', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error processing frame:', error);
                    updateStatus('Error processing frame', 'danger');
                });
            }
        }, 'image/jpeg', 0.8);
    }
}

function updateStatus(message, type) {
    const statusDiv = document.getElementById('status');
    const alertClass = 'alert alert-' + type;
    const icon = getIcon(type);
    
    statusDiv.innerHTML = '<div class="' + alertClass + '"><i class="' + icon + '"></i> ' + message + '</div>';
}

function getIcon(type) {
    const icons = {
        'success': 'fas fa-check-circle',
        'danger': 'fas fa-exclamation-triangle',
        'warning': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle',
        'secondary': 'fas fa-stop-circle'
    };
    return icons[type] || 'fas fa-info-circle';
}

function loadSessionInfo() {
    fetch('/current_session')
        .then(response => response.json())
        .then(data => {
            const sessionDiv = document.getElementById('sessionInfo');
            
            // Create session info display
            let sessionHtml = '';
            if (data.session_active) {
                sessionHtml = '<div class="row"><div class="col-md-6"><strong>Session:</strong> ' + data.session_date + '</div><div class="col-md-6"><strong>Status:</strong> <span class="badge bg-success">Active</span></div></div><div class="row mt-2"><div class="col-md-6"><strong>Total Present:</strong> ' + data.total_present + '</div><div class="col-md-6"><strong>Last Updated:</strong> ' + (data.last_updated || 'Never') + '</div></div>';
            } else {
                sessionHtml = '<div class="text-center"><span class="badge bg-warning">No Active Session</span><p class="mt-2 mb-0">Contact administrator to start attendance session</p></div>';
            }
            
            // Add daily attendance summary
            if (data.daily_attendance) {
                const daily = data.daily_attendance;
                sessionHtml += '<hr><div class="row"><div class="col-12"><h6 class="mb-2"><i class="fas fa-calendar-day"></i> Today\'s Attendance (' + daily.date + ')</h6></div></div>';
                sessionHtml += '<div class="row"><div class="col-md-4"><small><strong>Total Students:</strong> ' + daily.total_students + '</small></div>';
                sessionHtml += '<div class="col-md-4"><small><strong>Checked In:</strong> <span class="badge bg-success">' + daily.checked_in + '</span></small></div>';
                sessionHtml += '<div class="col-md-4"><small><strong>Checked Out:</strong> <span class="badge bg-info">' + daily.checked_out + '</span></small></div></div>';
                
                if (daily.recent_activity && daily.recent_activity.length > 0) {
                    sessionHtml += '<div class="mt-2"><small><strong>Recent Activity:</strong></small><ul class="list-unstyled mb-0" style="max-height: 100px; overflow-y: auto;">';
                    daily.recent_activity.forEach(activity => {
                        const badgeClass = activity.action === 'in' ? 'bg-success' : 'bg-info';
                        sessionHtml += '<li><small>' + activity.student_id + ' <span class="badge ' + badgeClass + '">' + activity.action + '</span> at ' + activity.time + '</small></li>';
                    });
                    sessionHtml += '</ul></div>';
                }
            }
            
            sessionDiv.innerHTML = sessionHtml;
        })
        .catch(error => {
            console.error('Error loading session info:', error);
            document.getElementById('sessionInfo').innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-triangle"></i> Error loading session information</div>';
        });
}

// Load session info on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSessionInfo();
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden && stream) {
        stopCamera();
    }
});

// Handle beforeunload to cleanup
window.addEventListener('beforeunload', function() {
    if (stream) {
        stopCamera();
    }
});
</script>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
}

.card-header {
    border-bottom: none;
}

video {
    max-width: 100%;
    height: auto;
}

@media (max-width: 768px) {
    video {
        width: 100%;
        height: auto;
    }
    
    canvas {
        width: 100%;
        height: auto;
    }
}

.btn-lg {
    padding: 12px 24px;
    font-size: 1.1rem;
}

.alert {
    margin-bottom: 0;
}

.badge {
    font-size: 0.9rem;
}
</style>
{% endblock %}
