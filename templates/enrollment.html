{% extends "base.html" %}

{% block title %}Student Enrollment - Face Recognition Attendance{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-user-plus"></i> Student Enrollment</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Camera Feed -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-camera"></i> Camera Feed</h5>
                            </div>
                            <div class="card-body">
                                <div class="video-container">
                                    <video id="video" autoplay muted></video>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button id="initCameraBtn" class="btn btn-primary btn-capture">
                                        <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                        <span class="btn-text">
                                            <i class="fas fa-video"></i> Start Camera
                                        </span>
                                    </button>
                                    
                                    <button id="captureBtn" class="btn btn-success btn-capture" disabled>
                                        <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                                        <span class="btn-text">
                                            <i class="fas fa-camera-retro"></i> Capture & Enroll
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enrollment Form -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-edit"></i> Enrollment Details</h5>
                            </div>
                            <div class="card-body">
                                <form id="enrollmentForm">
                                    <div class="mb-3">
                                        <label for="studentId" class="form-label">Student ID</label>
                                        <input type="text" class="form-control" id="studentId" 
                                               placeholder="Enter student ID" required>
                                        <div class="form-text">Unique identifier for the student</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="modelSelect" class="form-label">Recognition Model</label>
                                        <select class="form-select" id="modelSelect">
                                            {% for model in models %}
                                            <option value="{{ model }}" {% if model == 'MobileNetV2' %}selected{% endif %}>
                                                {{ model }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">AI model for face recognition</div>
                                    </div>
                                    
                                    <button type="button" id="initModelBtn" class="btn btn-outline-primary btn-sm mb-3">
                                        <i class="fas fa-sync"></i> Initialize Model
                                    </button>
                                    
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Instructions:</h6>
                                        <ol class="mb-0 small">
                                            <li>Enter the student ID</li>
                                            <li>Start the camera</li>
                                            <li>Position face clearly in frame</li>
                                            <li>Click "Capture & Enroll"</li>
                                        </ol>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Quality Indicators -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-line"></i> Quality Check</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="quality-indicator" id="faceSize">
                                            <i class="fas fa-expand-alt fa-2x text-muted"></i>
                                            <div class="small mt-1">Face Size</div>
                                            <div class="badge bg-secondary">--</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-indicator" id="imageQuality">
                                            <i class="fas fa-eye fa-2x text-muted"></i>
                                            <div class="small mt-1">Clarity</div>
                                            <div class="badge bg-secondary">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enrolled Students -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-users"></i> Enrolled Students</h5>
                                <button id="refreshStudentsBtn" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="studentsTable">
                                        <thead>
                                            <tr>
                                                <th>Student ID</th>
                                                <th>Samples</th>
                                                <th>Model</th>
                                                <th>Created</th>
                                                <th>Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentModel = 'MobileNetV2';
    let modelInitialized = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners
        document.getElementById('initCameraBtn').addEventListener('click', handleInitCamera);
        document.getElementById('captureBtn').addEventListener('click', handleCapture);
        document.getElementById('initModelBtn').addEventListener('click', handleInitModel);
        document.getElementById('refreshStudentsBtn').addEventListener('click', loadEnrolledStudents);
        document.getElementById('modelSelect').addEventListener('change', handleModelChange);
        
        // Load enrolled students on page load
        loadEnrolledStudents();
    });
    
    async function handleInitCamera() {
        setLoading('initCameraBtn', true);
        
        try {
            await initCamera();
            document.getElementById('captureBtn').disabled = false;
            showAlert('Camera initialized successfully!', 'success');
        } catch (error) {
            showAlert('Failed to initialize camera: ' + error.message, 'danger');
        } finally {
            setLoading('initCameraBtn', false);
        }
    }
    
    async function handleCapture() {
        const studentId = document.getElementById('studentId').value.trim();
        
        if (!studentId) {
            showAlert('Please enter a student ID', 'warning');
            return;
        }
        
        if (!modelInitialized) {
            showAlert('Please initialize the model first', 'warning');
            return;
        }
        
        setLoading('captureBtn', true);
        
        try {
            const imageData = captureFrame();
            
            const response = await apiRequest('/api/enroll', {
                student_id: studentId,
                image: imageData
            });
            
            if (response.success) {
                showAlert(response.message, 'success');
                updateQualityIndicators(response);
                loadEnrolledStudents(); // Refresh the students table
                
                // Clear the student ID for next enrollment
                document.getElementById('studentId').value = '';
            } else {
                showAlert(response.message, 'danger');
            }
            
        } catch (error) {
            showAlert('Enrollment failed: ' + error.message, 'danger');
        } finally {
            setLoading('captureBtn', false);
        }
    }
    
    async function handleInitModel() {
        const selectedModel = document.getElementById('modelSelect').value;
        
        try {
            showAlert('Initializing model...', 'info');
            
            const response = await apiRequest('/api/initialize_model', {
                model: selectedModel
            });
            
            if (response.success) {
                currentModel = selectedModel;
                modelInitialized = true;
                showAlert(response.message, 'success');
            } else {
                showAlert('Model initialization failed: ' + response.message, 'danger');
                modelInitialized = false;
            }
            
        } catch (error) {
            showAlert('Model initialization error: ' + error.message, 'danger');
            modelInitialized = false;
        }
    }
    
    function handleModelChange() {
        modelInitialized = false;
        showAlert('Model changed. Please click "Initialize Model" to load the new model.', 'info');
    }
    
    async function loadEnrolledStudents() {
        try {
            const response = await fetch('/api/students');
            const data = await response.json();
            
            const tbody = document.querySelector('#studentsTable tbody');
            
            if (data.success && data.students.length > 0) {
                tbody.innerHTML = data.students.map(student => `
                    <tr>
                        <td><strong>${student.id}</strong></td>
                        <td><span class="badge bg-primary">${student.samples}</span></td>
                        <td><span class="badge bg-info">${student.model}</span></td>
                        <td class="small text-muted">${formatDate(student.created)}</td>
                        <td class="small text-muted">${formatDate(student.last_updated)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-user-slash"></i> No students enrolled yet
                        </td>
                    </tr>
                `;
            }
            
        } catch (error) {
            console.error('Error loading students:', error);
            document.querySelector('#studentsTable tbody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading students
                    </td>
                </tr>
            `;
        }
    }
    
    function updateQualityIndicators(response) {
        // Update face size indicator
        const faceArea = response.face_area || 0;
        const faceSizeElement = document.querySelector('#faceSize .badge');
        const faceSizeIcon = document.querySelector('#faceSize i');
        
        if (faceArea >= 5000) {
            faceSizeElement.className = 'badge bg-success';
            faceSizeElement.textContent = 'Good';
            faceSizeIcon.className = 'fas fa-expand-alt fa-2x text-success';
        } else if (faceArea >= 2500) {
            faceSizeElement.className = 'badge bg-warning';
            faceSizeElement.textContent = 'OK';
            faceSizeIcon.className = 'fas fa-expand-alt fa-2x text-warning';
        } else {
            faceSizeElement.className = 'badge bg-danger';
            faceSizeElement.textContent = 'Small';
            faceSizeIcon.className = 'fas fa-expand-alt fa-2x text-danger';
        }
        
        // Update quality indicator
        const qualityScore = response.quality_score || 0;
        const qualityElement = document.querySelector('#imageQuality .badge');
        const qualityIcon = document.querySelector('#imageQuality i');
        
        if (qualityScore >= 200) {
            qualityElement.className = 'badge bg-success';
            qualityElement.textContent = 'Excellent';
            qualityIcon.className = 'fas fa-eye fa-2x text-success';
        } else if (qualityScore >= 100) {
            qualityElement.className = 'badge bg-warning';
            qualityElement.textContent = 'Good';
            qualityIcon.className = 'fas fa-eye fa-2x text-warning';
        } else {
            qualityElement.className = 'badge bg-danger';
            qualityElement.textContent = 'Blurry';
            qualityIcon.className = 'fas fa-eye fa-2x text-danger';
        }
    }
    
    function formatDate(dateString) {
        if (!dateString || dateString === 'Unknown') return 'Unknown';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        } catch {
            return dateString;
        }
    }
</script>
{% endblock %}